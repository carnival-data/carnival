
<div class="container-fluid" id="DeveloperSetup">
  <h1 class="mt-4">Developer Setup</h1>
  <p>
Carnival is a Groovy <a href="https://guides.gradle.org/creating-multi-project-builds/">multi-project</a> that uses <a href="https://gradle.org">Gradle</a> as the build engine. The main project is in the app directory. Folders within app contain the sub-projects (eg. app/public/carnival-core, app/public/carnival-gremlin-dsl). Every sub-project has a build.gradle configuration file that defines it's dependencies and the gradle tasks that it can execute. The build.gradle file in the app directory defines project-wide configuration.

Gradle task commands run from the root project filter down to the sub-projects. Gradle commands referenced in this documentation are assumed to be called from the root project directory carnival/app unless otherwise noted.

This project also includes a <a href="https://www.docker.com/resources/what-container">Docker image configuration</a> that can be built to run Carnival or the test suite.
  </p>

  <h2 class="mt-4">Installation</h2>

  <h3 class="mt-4">Build Requirements</h3>
  <ul>
    <li><a href="https://gradle.org/">Gradle</a> V5.1.1</li>
    <ul>
      <li><a href="https://gradle.org/install/#with-a-package-manager">Installation with a package manager</a></li>
      <ul>
        <li><a href="https://sdkman.io/">SDKMan</a></li>
        <li>Windows: <a href="http://www.cygwin.com/">Cygwin</a> + SDKMan</li>
        <li>Note - Cygwin needs curl installed for sdkman to work successfully. The windows 10 version of curl may cause an error when trying to install gradle. See <a href="https://stackoverflow.com/questions/56509430/sdkman-on-cygwin-cant-install">stack overflow.</a></li>
        <li>Windows: <a href="https://scoop.sh/">Scoop</a></li>
      </ul>
      <li><a href="https://gradle.org/install/#manually">Install Manually</a></li>
    </ul>
    <li>Java V1.8+</li>
    <li><a href="https://neo4j.com/download/">Neo4J</a> (Optional) - Helpful to browse the property graph.</li>
  </ul>

  <h3 class="mt-4">Environment Setup</h3>
  <ol>
    <li>
      Clone the repository using:
      <div class="listingblock">
        <div class="content">
          <pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">git clone git@github.com:pennbiobank/carnival-public.git</code></pre>
        </div>
      </div>
    </li>
    <li>
      Create a carnival home directory. This directory will contain your configuration files and will be the location where carnival reads and writes graphs and files.
      <div class="listingblock">
        <div class="content">
          <pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mkdir /Users/myuser/dev/carnival/carnival_home</code></pre>
        </div>
      </div>
    </li>
    <li>
      Make carnival aware of your carnival home directory. There are a couple of ways you can do this.
      <ul>
        <li>
          Use the environment variable CARNIVAL_HOME. For example:
          <div class="listingblock">
            <div class="content">
              <pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">export CARNIVAL_HOME=/Users/myuser/dev/carnival/carnival_home</code></pre>
            </div>
          </div>
        </li>
        <li>
          Pass your carnival home directory to future gradle commands using the <code class="language-bash" data-lang="bash">-D</code> syntax:
          <div class="listingblock">
            <div class="content">
              <pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">-Dcarnival.home=/Users/myuser/dev/carnival/carnival_home</code></pre>
            </div>
          </div>
          <p>
            <b>Note</b> - If you use this method, then you will need to edit logback.xml, which by default references <code class="language-bash" data-lang="bash">CARNIVAL_HOME</code>.
          </p>
        </li>
      </ul>
    </li>
    <li>
      Setup the configuration files in the <code class="language-bash" data-lang="bash">${CARNIVAL_HOME}/config directory</code>:
      <ul>
        <li>
          To set up the config files from scratch:
          <ul>
            <li>Copy the config template files from <code class="language-bash" data-lang="bash">carnival/app/carnival-core/config</code> to <code class="language-bash" data-lang="bash">${CARNIVAL_HOME}/config</code>.</li>
            <li>Rename the files named <code class="language-bash" data-lang="bash">*.*-template</code> to <code class="language-bash" data-lang="bash">*.*</code> (remove -template from the name).</li>
          </ul>
        </li>
      </ul>
      <p>
        <b>Note</b> - In the config files windows paths should be specified using double forward-slashes (i.e. <code class="language-bash" data-lang="bash">C://Users//myuser//somedirectory)</code>.
      </p>
      <ul>
        <li>
          File descriptions:
          <ul>
            <li>application.yaml - Contains data source information (i.e. credentals to relational dbs, RDF dbs, REDCap, etc.), the default vine cache-mode, local directory configuration and the gremlin configuration.</li>
            <li>logback.xml - Can be modified to change the log levels.</li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      Install APOC neo4j plugin:
      <ul>
        <li>Download the <a href="https://neo4j.com/docs/labs/apoc/current/">APOC</a> <a href="https://github.com/neo4j-contrib/neo4j-apoc-procedures/releases/tag/3.4.0.7">V3.4.0.7</a> and save it to a directory on your local file system.</li>
        <li>Add the path to that directory in gremlin section of the <code class="language-bash" data-lang="bash">application.yaml</code> config file in the entry <code class="language-bash" data-lang="bash">gremlin:neo4j:conf:dbms:directories:plugins</code>:</li>
      </ul>
        <div class="listingblock">
          <div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml"># gremlin
gremlin:
 neo4j:
   conf:
     dbms:
       directories:
         plugins: /Users/myuser/Documents/Neo4j/default.graphdb/plugins
       security:
         auth_enabled: "false"      
         procedures:
           unrestricted: apoc.*
           whitelist: apoc.*
</code></pre>
        </div>
      </div>
    </li>
  </ol>


  <h2 class="mt-4">Building</h2>

  <h3 class="mt-4">Overview</h3>
    <p>
      Carnival is a <a href="https://guides.gradle.org/creating-multi-project-builds/">Gradle multi-project</a> application comprised of sub-projects. Some sub-projects implement the data model and shared core functionality (carnival-core, carnival-util, carnival-graph, carnival-gremlin-dsl, etc.) and some extend the general data model to the biomedical domain (carnival-clinical).

      Every sub-project has a build.gradle configuration file that defines it's dependencies and the gradle tasks it can execute. The <code class="language-bash" data-lang="bash">build.gradle</code> file in the <code class="language-bash" data-lang="bash">carnival/app</code> directory defines project-wide configuration. These files also contain the default java arguments that are used for each task.  
    </p>

  <h3 class="mt-4">Compiling</h3>
    <p>
      Carnival can be built by running <code class="language-bash" data-lang="bash">gradle compileGroovy</code>. The build can be cleaned by running <code class="language-bash" data-lang="bash">gradle clean</code>. To run sub-project tasks, use the gradle colon syntax: <code class="language-bash" data-lang="bash">gradle :carnival-util:compileGroovy</code>.      
    </p>
  
  <h2 class="mt-4">Testing</h2>
    <p>
      <a href="https://docs.gradle.org/current/dsl/org.gradle.api.tasks.testing.Test.html">Gradle</a> is used to execute the test suite. Running tests produces html test result files in the sub-project directories <code class="language-bash" data-lang="bash">carnvial\app\carnival-*\build\reports\tests\test\index.html</code>.      
    </p>

  <h3 class="mt-4">Aggregating Test Results</h3>
    <p>
      Running the command gradle testReport will run all tests and generate aggregated results in <code class="language-bash" data-lang="bash">carnival\app\build\reports\allTests</code>.      
    </p>

  <h3 class="mt-4">Common Test Commands</h3>
    
    <p>To run tests for all gradle sub-projects: <code class="language-bash" data-lang="bash">gradle test</code></p>

    <p>To run tests for all gradle sub-projects and aggrigate the results: <code class="language-bash" data-lang="bash">gradle testReport</code></p>

    <p>To run tests in a specific gradle sub-project: <code class="language-bash" data-lang="bash">gradle :carnival-util:test</code></p>

    <p>
      To run a specific test suite, in this example the tests located in <code class="language-bash" data-lang="bash">carnival\app\carnival-graph/src/test/groovy/carnival/graph/VertexDefTraitSpec.groovy</code>:
    </p>
    <p>
      <code class="language-bash" data-lang="bash">gradle :carnival-graph:test --tests "carnival.graph.VertexDefTraitSpec"</code>
    </p>

    
  <h3 class="mt-4">HTTP Tests</h3>

    <p>Some of the tests require external HTTP resources. To run these tests:</p>

    <p><code class="language-bash" data-lang="bash">gradle -Dtest-http=true :carnival-core:test</code></p>

  <h3 class="mt-4">Running Tests using Docker</h3>

    <p>The test suite can be run in the context of a docker image. If running tests in this way gradle does not need to be installed, and any configuration in the users CARNIVAL_HOME directory will be ignored.</p>

  <h4 class="mt-4">Requirements</h4>

    <ul>
      <li>Docker</li>
      <ul>
        <li>Most recent stable release, minimum version is 17.06.0</li>
        <ul>
          <li><a href="https://docs.docker.com/engine/getstarted/step_one/">Official Docker Website Getting Started</a></li>
          <li><a href="https://docs.docker.com/docker-for-windows/install/">Official Docker Installation for Windows</a></li>
        </ul>
      </ul>
      <li>Docker-Compose (Version 1.22.0 or greater, Linux only) - Separate installation is only needed for linux, docker-compose is bundled with windows and mac docker installations</li>
      <ul>
        <li><a href="https://docs.docker.com/compose/install/">Linux Docker-Compose Installation</a></li>
      </ul>
    </ul>
    
  <h4 class="mt-4">Running Tests in the Docker Environment</h4>
    <ul>
      <li>First build the docker image using the command: <code class="language-bash" data-lang="bash">docker-compose -f .\docker-compose-test.yml build</code></li>
      <li>Once built, the tests can be run using the command: <code class="language-bash" data-lang="bash">docker-compose -f .\docker-compose-test.yml up --force-recreate</code></li>
      <li>This has the same effect as running gradle testReports, and the aggregated test results will be in the folder <code class="language-bash" data-lang="bash">carnival\app\build\reports\allTests</code>.</li>
    </ul>
  
  <h2 class="mt-4">Publishing Libraries</h2>
    <p>The Groovy sub-project modules can be published to local maven repositories by running commands like the following:</p>
    <p><code class="language-bash" data-lang="bash">gradle :carnival-util:publishToMavenLocal</code></p>
    <p><code class="language-bash" data-lang="bash">gradle :carnival-core:publishToMavenLocal</code></p>

    <p>To publish all modules:</p>
    <p><code class="language-bash" data-lang="bash">gradle publishAll</code></p>

</div>

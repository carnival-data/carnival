/**
 *
 * Carnival top level project.
 *
 */


///////////////////////////////////////////////////////////////////////////////
// plugins
///////////////////////////////////////////////////////////////////////////////

plugins {
    id 'groovy'
    id "com.github.ManifestClasspath" version "0.1.0-RELEASE"
}


///////////////////////////////////////////////////////////////////////////////
// app version
///////////////////////////////////////////////////////////////////////////////

allprojects {
    group = 'edu.upenn.pmbb'
    sourceCompatibility = 1.8
    version = '0.2.6'   // see https://semver.org/
}


subprojects {
    apply plugin: 'groovy'
}



///////////////////////////////////////////////////////////////////////////////
// Testing Tasks
///////////////////////////////////////////////////////////////////////////////


subprojects {
    test.ignoreFailures true

    test {
        systemProperty 'vine.config.file.path', System.getProperty('vine.config.file.path')
        systemProperty 'cgis.use.cached.data.files', System.getProperty('cgis.use.cached.data.files')
        systemProperty 'cgis.use.cached.graph', System.getProperty('cgis.use.cached.graph')
        systemProperty 'test.vine.live.data', System.getProperty('test.vine.live.data')
        systemProperty 'test.graph.rollback', System.getProperty('test.graph.rollback')
        systemProperty 'allow.redcap.modification', System.getProperty('allow.redcap.modification')
        systemProperty 'disable.filevine.tests', System.getProperty('disable.filevine.tests')
        testLogging {
            events 'standard_out'
        }

        if (System.getProperty('carnival.home')) {
            systemProperty('carnival.home', System.getProperty('carnival.home'))
            systemProperty('logback.configurationFile', System.getProperty('carnival.home') + '/config/logback.xml')
        }
        if (System.env.CARNIVAL_HOME) {
            systemProperty('logback.configurationFile', System.env.CARNIVAL_HOME + '/config/logback.xml')
        }
        if (System.getProperty('logback.configurationFile')) {
            systemProperty("logback.configurationFile", System.getProperty('logback.configurationFile'))
        } else if (System.env.CARNIVAL_LOGBACK_CONFIG) {
            systemProperty("logback.configurationFile", System.env.CARNIVAL_LOGBACK_CONFIG)
        }
        if (!(System.getProperty('carnival.home') || System.env.CARNIVAL_HOME)) {
            ant.echo "Carnival home is not set. Use command line argument -Dcarnival.home= or environment variable CARNIVAL_HOME. See documentation."
            if (!(System.getProperty('logback.configurationFile') || System.env.CARNIVAL_LOGBACK_CONFIG)) {
                ant.echo "Logback configuration file not set. Use the -D command line argument like -Dlogback.configurationFile=/path/to/file.xml.  Or, set the environment variable CARNIVAL_LOGBACK_CONFIG to /path/to/file.xml. See documentation."
            }
        }

        jvmArgs '-Xms4g'
        jvmArgs '-Xmx6g'
    }
}


task testReport(type: TestReport) {
    destinationDir = file("$buildDir/reports/allTests")

    // Include the results from the `test` task in all subprojects
    reportOn subprojects*.test

    ant.echo "TestReport - buildDir: $buildDir/reports/allTests"
}


///////////////////////////////////////////////////////////////////////////////
// convenience tasks
///////////////////////////////////////////////////////////////////////////////

task refreshGremlinDsl {
    dependsOn 'carnival-gremlin-dsl:publishToMavenLocal'
}

task refreshUtil {
    dependsOn refreshGremlinDsl
    dependsOn 'carnival-util:publishToMavenLocal'
}

task publishGraph {
    dependsOn refreshUtil
    dependsOn 'carnival-graph:publishToMavenLocal'
    dependsOn 'carnival-gremlin-dsl:publishToMavenLocal'
}

task publishCore {
    dependsOn publishGraph
    dependsOn 'carnival-core:publishToMavenLocal'
}

task publishAll {
    dependsOn publishCore
    dependsOn 'carnival-clinical:publishToMavenLocal'
}

